services:
  attacker:
    build:
      context: ./attacker
    container_name: lab_attacker
    tty: true
    stdin_open: true
    command: ["tail", "-f", "/dev/null"]   # mantém o container vivo
    networks:
      - labnet
    # Se quiser que o `ping` funcione sem privilégios adicionais, descomente o exemplo abaixo
    # e habilite a capability NET_RAW. Manter comentado por padrão para não aumentar privilégios.
    cap_add:
      - NET_RAW
      - NET_ADMIN

  web_nginx:
    image: nginx:alpine
    container_name: lab_nginx
    networks:
      - labnet

  web_apache:
    image: httpd:alpine
    container_name: lab_apache
    networks:
      - labnet

  ssh:
    image: rastasheep/ubuntu-sshd:18.04
    container_name: lab_ssh
    command: >
      /bin/bash -c "
      service ssh start &&
      tail -f /dev/null
      "
    environment:
      - SSH_PASSWORD=toor
    networks:
      - labnet

  ftp:
    image: stilliard/pure-ftpd:hardened
    container_name: lab_ftp
    environment:
      - PUBLICHOST=localhost
      - FTP_USER_NAME=ftpuser          # Usuário FTP
      - FTP_USER_PASS=ftppass          # Senha FTP
      - FTP_USER_HOME=/home/ftpusers/ftpuser  # Diretório home
    networks:
      - labnet
    restart: unless-stopped

  mysql:
    image: mysql:5.7
    container_name: lab_mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: testdb
    networks:
      - labnet

  redis:
    image: redis:alpine
    container_name: lab_redis
    networks:
      - labnet

  smb:
    image: dperson/samba
    container_name: lab_smb
    command: "-s \"share;/data;yes;no;no;all;none\" -u \"guest;\""
    volumes:
      - ./smbdata:/data
    networks:
      - labnet

  smtp:
    image: mailhog/mailhog
    container_name: lab_smtp
    command: ["tail", "-f", "/dev/null"]   # mantém o container vivo
    networks:
      - labnet

  dns:
    image: andyshinn/dnsmasq:2.78
    container_name: lab_dns
    command: ["-k", "-C", "/etc/dnsmasq.conf"]
    volumes:
      - ./dnsmasq/dnsmasq.conf:/etc/dnsmasq.conf:ro
      - ./dnsmasq/dnsmasq.hosts:/etc/dnsmasq.hosts:ro
    cap_add:
      - NET_ADMIN
      - NET_BIND_SERVICE
      - NET_RAW
    networks:
      - labnet
    restart: unless-stopped

  vuln:
    build:
      context: ./vuln_service
    container_name: lab_vuln
    networks:
      - labnet
    # expõe só internamente para o lab; não publish para host

networks:
  labnet:
    driver: bridge
